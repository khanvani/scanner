
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ScanPro - Document Scanner</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mui/material@5.15.14/dist/material.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />
  <style>
    body { background: #f7f8fa; color: #222; font-family: 'Inter', 'Roboto', Arial, sans-serif; }
    .container { max-width: 420px; margin: auto; padding: 0 0 32px 0; }
    .header { text-align: center; padding: 32px 0 12px 0; }
    .header h1 { font-size: 2.1rem; font-weight: 700; color: #2563eb; margin: 0; }
    .header p { color: #64748b; margin: 8px 0 0 0; font-size: 1.1rem; }
    .card { background: #fff; border-radius: 18px; box-shadow: 0 2px 16px #0001; padding: 18px; margin-bottom: 18px; }
    .actions { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-bottom: 10px; }
    .btn { background: #2563eb; color: #fff; border: none; border-radius: 12px; padding: 12px 18px; font-weight: 600; font-size: 1rem; cursor: pointer; transition: background .2s; }
    .btn.secondary { background: #e0e7ef; color: #2563eb; }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    .scanner-video { width: 100%; border-radius: 12px; background: #000; margin-bottom: 10px; }
    .thumbs { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
    .thumb { border-radius: 12px; overflow: hidden; border: 1px solid #e0e7ef; width: 90px; height: 120px; position: relative; background: #f1f5f9; }
    .thumb img { width: 100%; height: 100%; object-fit: cover; }
    .thumb .btn { position: absolute; bottom: 6px; left: 50%; transform: translateX(-50%); font-size: .95rem; padding: 7px 12px; }
    .footer { text-align: center; color: #94a3b8; font-size: .95rem; margin-top: 24px; }
    @media (max-width: 600px) {
      .container { padding: 0 2px; }
      .thumb { width: 70px; height: 90px; }
    }
    .cropper-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 9999; }
    .cropper-box { background: #fff; border-radius: 16px; padding: 18px; max-width: 98vw; max-height: 90vh; }
    .cropper-img { max-width: 90vw; max-height: 70vh; display: block; margin: auto; border-radius: 12px; }
  </style>
  <script async src="https://docs.opencv.org/4.x/opencv.js" onload="window.cvReady=true"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>Document Scanner</h1>
    <p>Scan, crop, and save documents with ease.</p>
  </div>
  <div class="card">
    <div class="actions">
      <select id="cameraSelect" title="Choose camera" class="btn secondary"></select>
      <button id="refreshBtn" class="btn secondary">‚Üª</button>
      <button id="torchBtn" class="btn secondary">üî¶</button>
    </div>
    <video id="video" class="scanner-video" autoplay playsinline muted></video>
    <div class="actions">
      <button id="captureBtn" class="btn">üì∏ Capture</button>
    </div>
    <canvas id="workCanvas" hidden></canvas>
  </div>
  <div class="card">
    <div class="actions">
      <button id="saveAllBtn" class="btn secondary">üíæ JPGs</button>
      <button id="saveFolderBtn" class="btn secondary">üìÅ Folder</button>
      <button id="savePdfBtn" class="btn secondary">üìï PDF</button>
      <button id="clearAllBtn" class="btn secondary">üßπ Clear</button>
    </div>
    <div id="thumbs" class="thumbs"></div>
    <div style="text-align:center;color:#64748b;font-size:.98rem;margin-top:8px;">Tip: Tap a scan to crop and save.</div>
  </div>
  <div class="footer">&copy; 2025 Document Scanner. Powered by OpenCV & Cropper.js.</div>
</div>
<!-- Cropper Modal -->
<div id="cropperModal" class="cropper-modal" style="display:none;">
  <div class="cropper-box">
    <img id="cropperImg" class="cropper-img" />
    <div style="text-align:center;margin-top:12px;">
      <button class="btn" onclick="saveCrop()">Save</button>
      <button class="btn secondary" onclick="closeCropper()">Cancel</button>
    </div>
  </div>
</div>
<script>
// Utility
const $ = (s)=>document.querySelector(s);
const video = $('#video');
const workCanvas = $('#workCanvas');
const thumbs = $('#thumbs');
const captureBtn = $('#captureBtn');
const saveAllBtn = $('#saveAllBtn');
const saveFolderBtn = $('#saveFolderBtn');
const savePdfBtn = $('#savePdfBtn');
const clearAllBtn = $('#clearAllBtn');
const torchBtn = $('#torchBtn');
const cameraSelect = $('#cameraSelect');
const refreshBtn = $('#refreshBtn');
const supportBadge = $('#supportBadge');
const cvBadge = $('#cvBadge');
let mediaStream=null, track=null;
let pages=[];
let cropper = null;

// Camera
async function listCameras(){
  const devs = await navigator.mediaDevices.enumerateDevices();
  const cams = devs.filter(d=>d.kind==='videoinput');
  cameraSelect.innerHTML='';
  cams.forEach((d,i)=>{
    const o=document.createElement('option');o.value=d.deviceId;o.textContent=d.label||`Camera ${i+1}`;cameraSelect.appendChild(o);
  });
  const back=cams.find(c=>/back|rear|environment/i.test(c.label));
  if(back) cameraSelect.value=back.deviceId;
}
async function startCamera(deviceId){
  if(mediaStream){mediaStream.getTracks().forEach(t=>t.stop());mediaStream=null;track=null}
  const constraints = deviceId?{video:{deviceId:{exact:deviceId}, width:{ideal:2560}, height:{ideal:1440}}}:{video:{facingMode:'environment', width:{ideal:2560}, height:{ideal:1440}}};
  try{
    mediaStream=await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject=mediaStream;track=mediaStream.getVideoTracks()[0];
  }catch(e){alert('Camera error: '+e.message)}
}

// OpenCV
function waitForCV(){
  return new Promise((res)=>{
    const iv=setInterval(()=>{
      if(window.cv && window.cv.Mat){clearInterval(iv); cvBadge.textContent='OpenCV ‚úÖ'; res();}
    },80);
    setTimeout(()=>{cvBadge.textContent='OpenCV ‚ö†Ô∏è';},4000);
  });
}

// Capture
async function capture(){
  const settings = track?.getSettings?.()||{};
  const vw = settings.width || video.videoWidth;
  const vh = settings.height || video.videoHeight;
  if(!vw||!vh){alert('Video not ready');return}
  workCanvas.width=vw; workCanvas.height=vh; const ctx=workCanvas.getContext('2d',{alpha:false});
  ctx.imageSmoothingEnabled=true; ctx.imageSmoothingQuality='high';
  ctx.drawImage(video,0,0,vw,vh);
  const dataUrl=workCanvas.toDataURL('image/jpeg',0.95);
  const page={dataUrl,w:vw,h:vh};
  try{
    await waitForCV();
    const quad = await detectCornersOpenCV({dataUrl,w:vw,h:vh});
    if(quad) page.quad = quad;
  }catch(e){console.warn('Auto-detect failed', e)}
  pages.push(page);
  renderThumbs();
}

// Cropper.js integration
function openCropper(pageIdx) {
  const page = pages[pageIdx];
  const img = document.getElementById('cropperImg');
  img.src = page.dataUrl;
  document.getElementById('cropperModal').style.display = 'flex';
  setTimeout(() => {
    cropper = new Cropper(img, {
      viewMode: 1,
      autoCropArea: 1,
      movable: true,
      zoomable: true,
      rotatable: false,
      scalable: false,
      responsive: true,
      background: false
    });
  }, 100);
  cropperModal.dataset.pageIdx = pageIdx;
}
function closeCropper() {
  document.getElementById('cropperModal').style.display = 'none';
  if (cropper) { cropper.destroy(); cropper = null; }
}
function saveCrop() {
  if (!cropper) return;
  const pageIdx = cropperModal.dataset.pageIdx;
  const canvas = cropper.getCroppedCanvas({ imageSmoothingEnabled: true, imageSmoothingQuality: 'high' });
  pages[pageIdx].dataUrl = canvas.toDataURL('image/jpeg', 0.95);
  closeCropper();
  renderThumbs();
}

function renderThumbs() {
  thumbs.innerHTML = '';
  pages.forEach((page, idx) => {
    const div = document.createElement('div');
    div.className = 'thumb';
    div.innerHTML = `<img src="${page.dataUrl}"/><button class='mui-btn mui-btn--primary' onclick='openCropper(${idx})'>Edit</button>`;
    thumbs.appendChild(div);
  });
}

// Save flows
saveAllBtn.onclick=()=>{
  if(!pages.length) return alert('No pages');
  pages.forEach((p,i)=>{ const a=document.createElement('a'); a.href=p.dataUrl; a.download=`scan_${ts()}_${String(i+1).padStart(2,'0')}.jpg`; document.body.appendChild(a); a.click(); a.remove(); })
}
saveFolderBtn.onclick=async()=>{
  if(!pages.length) return alert('No pages'); if(!window.showDirectoryPicker) return alert('Your browser does not support File System Access API.');
  const dir=await window.showDirectoryPicker({mode:'readwrite'});
  for(let i=0;i<pages.length;i++){
    const fh=await dir.getFileHandle(`scan_${ts()}_${String(i+1).padStart(2,'0')}.jpg`,{create:true});
    const w=await fh.createWritable(); const res=await fetch(pages[i].dataUrl); await w.write(await res.blob()); await w.close();
  }
  alert('Saved to selected folder');
}
savePdfBtn.onclick=()=>{
  if(!pages.length) return alert('No pages');
  const { jsPDF } = window.jspdf; const pdf=new jsPDF({unit:'pt', format:'a4'});
  pages.forEach((p,i)=>{
    if(i>0) pdf.addPage();
    const pageW=pdf.internal.pageSize.getWidth(); const pageH=pdf.internal.pageSize.getHeight();
    const r=Math.min(pageW/p.w, pageH/p.h); const w=p.w*r, h=p.h*r; const x=(pageW-w)/2, y=(pageH-h)/2;
    pdf.addImage(p.dataUrl,'JPEG',x,y,w,h);
  });
  pdf.save('scans.pdf');
}
clearAllBtn.onclick=()=>{pages=[]; renderThumbs()}

torchBtn.onclick=async()=>{
  if(!track) return alert('No camera');
  const caps=track.getCapabilities?track.getCapabilities():{}; if(!('torch' in caps)) return alert('Torch not supported on this device');
  const settings=track.getSettings(); const cur=settings.torch||false; try{ await track.applyConstraints({advanced:[{torch:!cur}]}); }catch(e){ alert('Torch toggle failed: '+e.message) }
}

cameraSelect.addEventListener('change',()=>startCamera(cameraSelect.value));
refreshBtn.addEventListener('click',async()=>{await listCameras(); await startCamera(cameraSelect.value||undefined)});
captureBtn.addEventListener('click',capture);

// OpenCV corner detection
async function detectCornersOpenCV(page){
  await waitForCV();
  const c=document.createElement('canvas'); c.width=page.w; c.height=page.h;
  const ctx=c.getContext('2d'); const img=new Image(); img.src=page.dataUrl; await img.decode(); ctx.drawImage(img,0,0);
  const imgData=ctx.getImageData(0,0,c.width,c.height);
  const src=cv.matFromImageData(imgData);
  const gray=new cv.Mat(); cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
  const blur=new cv.Mat(); cv.GaussianBlur(gray, blur, new cv.Size(7,7), 0);
  const edges=new cv.Mat(); cv.Canny(blur, edges, 30, 120);
  const kernel=cv.getStructuringElement(cv.MORPH_RECT, new cv.Size(5,5));
  cv.dilate(edges, edges, kernel);
  const contours=new cv.MatVector(); const hierarchy=new cv.Mat();
  cv.findContours(edges, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);
  let best=null, bestArea=0;
  for(let i=0;i<contours.size();i++){
    const cnt=contours.get(i);
    const peri=cv.arcLength(cnt,true);
    const approx=new cv.Mat(); cv.approxPolyDP(cnt, approx, 0.018*peri, true);
    if(approx.rows===4){
      const area=cv.contourArea(approx);
      if(area>bestArea){ bestArea=area; best=approx; }
    }
    approx.delete(); cnt.delete();
  }
  let quad=null;
  if(best){
    const pts=[]; for(let i=0;i<4;i++){ const p=best.intPtr(i); pts.push({x:p[0], y:p[1]}); }
    pts.sort((a,b)=>a.y-b.y);
    const top=pts.slice(0,2).sort((a,b)=>a.x-b.x);
    const bot=pts.slice(2,4).sort((a,b)=>a.x-b.x);
    quad=[top[0], top[1], bot[1], bot[0]];
  }
  src.delete(); gray.delete(); blur.delete(); edges.delete(); kernel.delete(); contours.delete(); hierarchy.delete();
  return quad;
}

function ts(){const d=new Date();return d.toISOString().replace(/[:.]/g,'-')}

// Initial load
window.addEventListener('DOMContentLoaded', async () => {
  supportBadge.textContent = `FSAccess ${window.showDirectoryPicker?'‚úÖ':'‚ùå'}`;
  await listCameras();
  await startCamera(cameraSelect.value||undefined);
});
</script>
</body>
</html>
