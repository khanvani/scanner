<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sewadar Document Scanner</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <style>
    body { background: #181c24; color: #f3f4f6; font-family: 'Inter', 'Roboto', Arial, sans-serif; margin:0; height: 100vh; overflow: hidden; }
    .fixed-header {
      position: fixed; top: 0; left: 0; width: 100vw; height: 54px;
      background: linear-gradient(90deg, #3a4256 60%, #4f8cff 100%);
      color: #fff; display: flex; align-items: center; justify-content: center;
      font-size: 1.15rem; font-weight: 600; letter-spacing: 1px; z-index: 100; box-shadow: 0 2px 8px rgba(0,0,0,0.10);
      border-bottom-left-radius: 18px; border-bottom-right-radius: 18px;
    }
    /* --- Improved Footer for Mobile --- */
    .fixed-footer {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100vw;
      height: 64px;
      background: linear-gradient(90deg, #23283a 60%, #2e3446 100%);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.10);
      border-top-left-radius: 18px; border-top-right-radius: 18px;
    }
    .footer-menu {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      max-width: 370px;
      margin: 0 auto;
      padding: 0 8px;
    }
    .footer-btn {
      background: #23283a;
      border: none;
      color: #fff;
      font-size: 1.45rem;
      margin: 0 4px;
      padding: 0;
      width: 38px;
      height: 38px;
      border-radius: 50%;
      transition: background 0.2s, box-shadow 0.2s;
      cursor: pointer;
      outline: none;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.10);
    }
    .footer-btn:active {
      background: #444;
      box-shadow: 0 2px 12px rgba(0,0,0,0.18);
    }
    .footer-btn.capture {
      background: linear-gradient(90deg, #00c853 60%, #4f8cff 100%);
      color: #fff;
      font-size: 2rem;
      box-shadow: 0 2px 12px rgba(0,200,83,0.3);
      width: 48px;
      height: 48px;
      padding: 0;
      border-radius: 50%;
      margin: 0 8px;
      border: 2px solid #fff;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .footer-btn.capture:active {
      background: linear-gradient(90deg, #009624 60%, #3a6edc 100%);
    }
    .scanner-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      position: relative;
      margin-top: 64px;
      margin-bottom: 80px;
      height: calc(100vh - 144px);
      width: 100vw;
      overflow: hidden;
      background: none;
    }
    .scanner-card {
      background: linear-gradient(120deg, #23283a 60%, #2e3446 100%);
      border-radius: 22px;
      box-shadow: 0 4px 32px rgba(0,0,0,0.18);
      padding: 18px 8px 8px 8px;
      max-width: 420px;
      width: 96vw;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      height: 100%;
    }
    .scanner-video {
      width: 100%;
      flex: 1 1 auto;
      min-height: 180px;
      max-height: 60vh;
      border-radius: 18px;
      box-shadow: 0 2px 16px rgba(0,0,0,0.18);
      object-fit: cover;
      background: #222;
      margin: 0 auto;
      display: block;
      border: 2px solid #2e3446;
    }
    .video-overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
    }
    @media (max-width: 480px) {
      .fixed-header {
        height: 48px;
        font-size: 1rem;
      }
      .fixed-footer {
        height: 56px;
        padding-bottom: env(safe-area-inset-bottom);
      }
      .footer-menu {
        max-width: 98vw;
        padding: 0 2vw;
      }
      .footer-btn, .footer-btn.capture {
        width: 34px;
        height: 34px;
        font-size: 1.1rem;
        margin: 0 2px;
      }
      .footer-btn.capture {
        width: 40px;
        height: 40px;
        font-size: 1.5rem;
      }
      .scanner-card {
        padding: 8px 2vw 8px 2vw;
        height: 100%;
      }
      .scanner-video {
        min-height: 120px;
        max-height: 40vh;
        border-radius: 12px;
      }
    }
    .cropper-modal {
      position: fixed;
      inset: 0;
      background: #181c24ee;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 0;
      backdrop-filter: blur(2px);
      transition: opacity 0.2s;
    }
    .cropper-box {
      background: #23283a;
      border-radius: 20px;
      padding: 24px 18px 18px 18px;
      max-width: 96vw;
      max-height: 88vh;
      box-shadow: 0 2px 32px #23283a88;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .cropper-img {
      max-width: 90vw;
      max-height: 60vh;
      display: block;
      margin: auto;
      border-radius: 16px;
      box-shadow: 0 2px 16px rgba(0,0,0,0.18);
      background: #222;
    }
    .cropper-box button {
      margin: 0 8px;
      font-size: 1.3rem;
      padding: 8px 18px;
      border-radius: 10px;
      border: none;
      background: #00c853;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,200,83,0.12);
      transition: background 0.2s;
    }
    .cropper-box button.secondary {
      background: #444;
    }
    .cropper-box button:active {
      background: #009624;
    }
  </style>
  <script async src="https://docs.opencv.org/4.x/opencv.js" onload="window.cvReady=true"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="fixed-header">Sewadar Document Scanner</div>
    <div class="scanner-card">
      <div style="display:flex;flex-direction:column;align-items:stretch;justify-content:flex-start;height:100%;width:100%;">
        <video id="video" class="scanner-video" autoplay playsinline muted></video>
        <svg id="videoOverlay" class="video-overlay"></svg>
        <canvas id="workCanvas" hidden></canvas>
        <div id="thumbs" class="thumbs" style="display:flex;flex-wrap:wrap;justify-content:center;margin-top:10px;"></div>
        <div style="text-align:center;color:#a3a8b8;font-size:.98rem;margin-top:8px;">Swipe scans below. Tap to crop & save.</div>
      </div>
    </div>
  <!-- Replace the footer HTML -->
  <div class="fixed-footer">
    <div class="footer-menu">
      <div style="display: flex; gap: 0; align-items: center;">
        <select id="cameraSelect" title="Choose camera" class="footer-btn" style="width:38px;height:38px;font-size:0.9rem;padding:0 4px;background:#23283a;color:#fff;border:none;border-radius:50%;margin-right:2px;"></select>
        <button class="footer-btn" id="btnTorch" title="Toggle Torch"><i class="fas fa-bolt"></i></button>
      </div>
      <button class="footer-btn capture" id="btnCapture" title="Capture"><i class="fas fa-camera"></i></button>
      <div style="display: flex; gap: 0; align-items: center;">
        <button class="footer-btn" id="btnSavePDF" title="Save as PDF"><i class="fas fa-file-pdf"></i></button>
        <button class="footer-btn" id="btnClear" title="Clear Gallery"><i class="fas fa-trash"></i></button>
      </div>
    </div>
  </div>
  <!-- Cropper Modal -->
  <div id="cropperModal" class="cropper-modal" style="display:none;">
    <div class="cropper-box">
      <img id="cropperImg" class="cropper-img" />
      <div style="text-align:center;margin-top:12px;">
        <button class="btn" onclick="saveCrop()">✔</button>
        <button class="btn secondary" onclick="closeCropper()">✖</button>
      </div>
    </div>
  </div>
  <script>
    window.addEventListener('DOMContentLoaded', async () => {
      let video = document.getElementById('video');
      let canvas = document.getElementById('workCanvas');
      let thumbs = document.getElementById('thumbs');
      let cameraSelect = document.getElementById('cameraSelect');
      let btnCapture = document.getElementById('btnCapture');
      let btnTorch = document.getElementById('btnTorch');
      let btnSavePDF = document.getElementById('btnSavePDF');
      let btnClear = document.getElementById('btnClear');
      let cropperModal = document.getElementById('cropperModal');
      let cropperImg = document.getElementById('cropperImg');
      let cropper = null;
      let scans = [];
      let stream = null;
      let track = null;
      let torchOn = false;

      async function listCameras() {
        const devices = await navigator.mediaDevices.enumerateDevices();
        cameraSelect.innerHTML = '';
        devices.filter(d => d.kind === 'videoinput').forEach((d, i) => {
          let opt = document.createElement('option');
          opt.value = d.deviceId;
          opt.textContent = d.label || `Camera ${i+1}`;
          cameraSelect.appendChild(opt);
        });
      }

      async function startCamera(deviceId) {
        if (stream) {
          stream.getTracks().forEach(t => t.stop());
        }
        let constraints = {
          video: { deviceId: deviceId ? { exact: deviceId } : undefined, facingMode: 'environment' }
        };
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        track = stream.getVideoTracks()[0];
      }

      cameraSelect.addEventListener('change', () => startCamera(cameraSelect.value));

      btnTorch.addEventListener('click', async () => {
        if (!track) return;
        const cap = track.getCapabilities();
        if (cap.torch) {
          torchOn = !torchOn;
          await track.applyConstraints({ advanced: [{ torch: torchOn }] });
        }
      });

      btnCapture.addEventListener('click', async () => {
        if (!video.srcObject) return;
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        let ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        let imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        if (window.cvReady && window.cv) {
          let src = cv.matFromImageData(imgData);
          let dst = new cv.Mat();
          cv.cvtColor(src, dst, cv.COLOR_RGBA2GRAY);
          cv.GaussianBlur(dst, dst, new cv.Size(5,5), 0, 0, cv.BORDER_DEFAULT);
          cv.Canny(dst, dst, 50, 150);
          let contours = new cv.MatVector();
          let hierarchy = new cv.Mat();
          cv.findContours(dst, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);
          let maxArea = 0, maxContour = null;
          for (let i = 0; i < contours.size(); i++) {
            let cnt = contours.get(i);
            let area = cv.contourArea(cnt);
            if (area > maxArea) {
              maxArea = area;
              maxContour = cnt;
            }
          }
          if (maxContour && maxArea > 10000) {
            let rect = cv.boundingRect(maxContour);
            let cropCanvas = document.createElement('canvas');
            cropCanvas.width = rect.width;
            cropCanvas.height = rect.height;
            cropCanvas.getContext('2d').drawImage(canvas, rect.x, rect.y, rect.width, rect.height, 0, 0, rect.width, rect.height);
            let dataUrl = cropCanvas.toDataURL('image/png');
            scans.push(dataUrl);
          } else {
            scans.push(canvas.toDataURL('image/png'));
          }
          src.delete(); dst.delete(); contours.delete(); hierarchy.delete();
        } else {
          scans.push(canvas.toDataURL('image/png'));
        }
        renderThumbs();
      });

      function renderThumbs() {
        thumbs.innerHTML = '';
        scans.forEach((src, idx) => {
          let img = document.createElement('img');
          img.src = src;
          img.style.width = '80px';
          img.style.height = '80px';
          img.style.objectFit = 'cover';
          img.style.margin = '6px';
          img.style.borderRadius = '10px';
          img.style.cursor = 'pointer';
          img.onclick = () => openCropper(idx);
          thumbs.appendChild(img);
        });
      }

      function openCropper(idx) {
        cropperModal.style.display = '';
        document.body.style.overflow = 'hidden'; // Prevent background scroll
        document.querySelector('.scanner-area').style.filter = 'blur(2px)'; // Blur background
        cropperImg.src = scans[idx];
        cropper = new Cropper(cropperImg, {
          viewMode: 1,
          autoCropArea: 1,
          movable: true,
          zoomable: true,
          scalable: true,
          rotatable: true
        });
        cropperModal.dataset.idx = idx;
      }

      window.closeCropper = function() {
        cropperModal.style.display = 'none';
        document.body.style.overflow = '';
        document.querySelector('.scanner-area').style.filter = '';
        if (cropper) cropper.destroy();
        cropper = null;
      }

      window.saveCrop = function() {
        if (!cropper) return;
        let idx = cropperModal.dataset.idx;
        let cropped = cropper.getCroppedCanvas().toDataURL('image/png');
        scans[idx] = cropped;
        renderThumbs();
        window.closeCropper();
      }

      btnSavePDF.addEventListener('click', () => {
        if (!scans.length) return;
        const { jsPDF } = window.jspdf;
        let pdf = new jsPDF({ orientation: 'portrait', unit: 'px', format: [595, 842] }); // A4 size in px
        let addImageToPDF = (imgSrc, isFirst) => {
          return new Promise(resolve => {
            let img = new Image();
            img.onload = function() {
              let pageWidth = pdf.internal.pageSize.getWidth();
              let pageHeight = pdf.internal.pageSize.getHeight();
              let w = img.width;
              let h = img.height;
              let scale = Math.min(pageWidth / w, pageHeight / h);
              let nw = w * scale;
              let nh = h * scale;
              let x = (pageWidth - nw) / 2;
              let y = (pageHeight - nh) / 2;
              pdf.addImage(img, 'PNG', x, y, nw, nh, undefined, 'FAST');
              resolve();
            };
            img.src = imgSrc;
          });
        };
        (async () => {
          for (let i = 0; i < scans.length; i++) {
            if (i > 0) pdf.addPage();
            await addImageToPDF(scans[i], i === 0);
          }
          pdf.save('sewadar_document.pdf');
        })();
      });

      btnClear.addEventListener('click', () => {
        scans = [];
        renderThumbs();
      });

      await listCameras();
      if (cameraSelect.options.length) {
        await startCamera(cameraSelect.value);
      }
    });
  </script>
</body>
</html>
